<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 2 Cluster analysis | Analysis Methods for Complex Data Structures: Spatial Data</title>
  <meta name="description" content="Chapter 2 Cluster analysis | Analysis Methods for Complex Data Structures: Spatial Data" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 2 Cluster analysis | Analysis Methods for Complex Data Structures: Spatial Data" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 2 Cluster analysis | Analysis Methods for Complex Data Structures: Spatial Data" />
  
  
  

<meta name="author" content="Mark Green" />


<meta name="date" content="2021-09-30" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="intro.html"/>
<link rel="next" href="spatreg.html"/>
<script src="libs/header-attrs-2.6/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Spatial Data practical resources for Complex Data Structure</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Overview</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#learning-outcomes"><i class="fa fa-check"></i>Learning outcomes</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#teaching-structure"><i class="fa fa-check"></i>Teaching structure</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#computational-notebooks"><i class="fa fa-check"></i>Computational notebooks</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#contact"><i class="fa fa-check"></i>Contact</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>1</b> Mapping data</a>
<ul>
<li class="chapter" data-level="1.1" data-path="intro.html"><a href="intro.html#why-map"><i class="fa fa-check"></i><b>1.1</b> Why map?</a></li>
<li class="chapter" data-level="1.2" data-path="intro.html"><a href="intro.html#mapping-in-r"><i class="fa fa-check"></i><b>1.2</b> Mapping in R</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="intro.html"><a href="intro.html#areas"><i class="fa fa-check"></i><b>1.2.1</b> Areas</a></li>
<li class="chapter" data-level="1.2.2" data-path="intro.html"><a href="intro.html#points"><i class="fa fa-check"></i><b>1.2.2</b> Points</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="intro.html"><a href="intro.html#interactive-maps"><i class="fa fa-check"></i><b>1.3</b> Interactive maps</a></li>
<li class="chapter" data-level="1.4" data-path="intro.html"><a href="intro.html#summary"><i class="fa fa-check"></i><b>1.4</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="cluster.html"><a href="cluster.html"><i class="fa fa-check"></i><b>2</b> Cluster analysis</a>
<ul>
<li class="chapter" data-level="2.1" data-path="cluster.html"><a href="cluster.html#point-data"><i class="fa fa-check"></i><b>2.1</b> Point data</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="cluster.html"><a href="cluster.html#spatial-histograms"><i class="fa fa-check"></i><b>2.1.1</b> Spatial histograms</a></li>
<li class="chapter" data-level="2.1.2" data-path="cluster.html"><a href="cluster.html#kernal-density-estimation"><i class="fa fa-check"></i><b>2.1.2</b> Kernal Density Estimation</a></li>
<li class="chapter" data-level="2.1.3" data-path="cluster.html"><a href="cluster.html#spatial-interpolation"><i class="fa fa-check"></i><b>2.1.3</b> Spatial interpolation</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="cluster.html"><a href="cluster.html#area-data"><i class="fa fa-check"></i><b>2.2</b> Area data</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="cluster.html"><a href="cluster.html#global-morans-i"><i class="fa fa-check"></i><b>2.2.1</b> Global Moran’s I</a></li>
<li class="chapter" data-level="2.2.2" data-path="cluster.html"><a href="cluster.html#local-morans-i"><i class="fa fa-check"></i><b>2.2.2</b> Local Moran’s I</a></li>
<li class="chapter" data-level="2.2.3" data-path="cluster.html"><a href="cluster.html#getis-ord-gi-statistic"><i class="fa fa-check"></i><b>2.2.3</b> Getis-Ord Gi statistic</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="cluster.html"><a href="cluster.html#summary-1"><i class="fa fa-check"></i><b>2.3</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="spatreg.html"><a href="spatreg.html"><i class="fa fa-check"></i><b>3</b> Spatial Regression</a>
<ul>
<li class="chapter" data-level="3.1" data-path="spatreg.html"><a href="spatreg.html#exploring-the-data"><i class="fa fa-check"></i><b>3.1</b> Exploring the data</a></li>
<li class="chapter" data-level="3.2" data-path="spatreg.html"><a href="spatreg.html#non-spatial-regression"><i class="fa fa-check"></i><b>3.2</b> Non-spatial regression</a></li>
<li class="chapter" data-level="3.3" data-path="spatreg.html"><a href="spatreg.html#selecting-the-right-spatial-model"><i class="fa fa-check"></i><b>3.3</b> Selecting the right spatial model</a></li>
<li class="chapter" data-level="3.4" data-path="spatreg.html"><a href="spatreg.html#spatial-lag-model"><i class="fa fa-check"></i><b>3.4</b> Spatial lag model</a>
<ul>
<li class="chapter" data-level="3.4.1" data-path="spatreg.html"><a href="spatreg.html#slx-spatially-lagged-model"><i class="fa fa-check"></i><b>3.4.1</b> SLX spatially lagged model</a></li>
<li class="chapter" data-level="3.4.2" data-path="spatreg.html"><a href="spatreg.html#sar-spatial-lag"><i class="fa fa-check"></i><b>3.4.2</b> SAR Spatial Lag</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="spatreg.html"><a href="spatreg.html#spatial-error-models"><i class="fa fa-check"></i><b>3.5</b> Spatial error models</a>
<ul>
<li class="chapter" data-level="3.5.1" data-path="spatreg.html"><a href="spatreg.html#spatial-error-model-sem"><i class="fa fa-check"></i><b>3.5.1</b> Spatial Error Model (SEM)</a></li>
<li class="chapter" data-level="3.5.2" data-path="spatreg.html"><a href="spatreg.html#spatial-durbin-error"><i class="fa fa-check"></i><b>3.5.2</b> Spatial Durbin Error</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="spatreg.html"><a href="spatreg.html#summary-2"><i class="fa fa-check"></i><b>3.6</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="gwr.html"><a href="gwr.html"><i class="fa fa-check"></i><b>4</b> Geographically Weighted Regression</a>
<ul>
<li class="chapter" data-level="4.1" data-path="gwr.html"><a href="gwr.html#loading-data"><i class="fa fa-check"></i><b>4.1</b> Loading data</a></li>
<li class="chapter" data-level="4.2" data-path="gwr.html"><a href="gwr.html#selecting-bandwidths"><i class="fa fa-check"></i><b>4.2</b> Selecting bandwidths</a></li>
<li class="chapter" data-level="4.3" data-path="gwr.html"><a href="gwr.html#running-the-model"><i class="fa fa-check"></i><b>4.3</b> Running the model</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="gwr.html"><a href="gwr.html#assessing-model-fit"><i class="fa fa-check"></i><b>4.3.1</b> Assessing model fit</a></li>
<li class="chapter" data-level="4.3.2" data-path="gwr.html"><a href="gwr.html#plotting-coefficients"><i class="fa fa-check"></i><b>4.3.2</b> Plotting coefficients</a></li>
<li class="chapter" data-level="4.3.3" data-path="gwr.html"><a href="gwr.html#assessing-statistical-significance-of-coefficients"><i class="fa fa-check"></i><b>4.3.3</b> Assessing statistical significance of coefficients</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="gwr.html"><a href="gwr.html#scaling-gwr-for-large-datasets"><i class="fa fa-check"></i><b>4.4</b> Scaling GWR for large datasets</a></li>
<li class="chapter" data-level="4.5" data-path="gwr.html"><a href="gwr.html#summary-3"><i class="fa fa-check"></i><b>4.5</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="intro.html"><a href="intro.html#summary"><i class="fa fa-check"></i><b>5</b> Summary</a>
<ul>
<li class="chapter" data-level="5.1" data-path="summary.html"><a href="summary.html"><i class="fa fa-check"></i><b>5.1</b> Learning outcomes</a></li>
<li class="chapter" data-level="5.2" data-path="summary.html"><a href="summary.html#further-learning"><i class="fa fa-check"></i><b>5.2</b> Further learning</a></li>
<li class="chapter" data-level="5.3" data-path="summary.html"><a href="summary.html#thank-you"><i class="fa fa-check"></i><b>5.3</b> Thank you</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Analysis Methods for Complex Data Structures: Spatial Data</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="cluster" class="section level1" number="2">
<h1><span class="header-section-number">Chapter 2</span> Cluster analysis</h1>
<p>In this section, we will introduce how we can analyse spatial data including identifying clustering of data. The lecture slides for this practical can be found <a href="">here</a>. A PDF version of the practical can be found <a href="">here</a>. We define clustering here as where data (locations, or high/low values) are geographically concentrated in particular areas and not evenly spread out.</p>
<div id="point-data" class="section level2" number="2.1">
<h2><span class="header-section-number">2.1</span> Point data</h2>
<p>There are numerous point-based methods including clustering algorithms, spatial scan metrics, and count regression models that we could talk about here - too much to cover in this section. Instead, we will focus on descriptive techniques for displaying point-based data.</p>
<div id="spatial-histograms" class="section level3" number="2.1.1">
<h3><span class="header-section-number">2.1.1</span> Spatial histograms</h3>
<p>One of the first steps we might take in trying to see if our point data are spatially clustered is by plotting their locations. This may be important if we are looking at the locations of disease cases or outbreaks, allowing us to make inferences about clustering of diseases and the reasons behind this. In the example here, we will look at food outlets in Liverpool to assess if they are geographically concentrated in particular areas of Liverpool.</p>
<p>We will first load in the data on locations of food outlets. The data are taken from the Food Standards Agency website <a href="https://ratings.food.gov.uk/">here</a> and are open data. While there are too many columns to describe here, it is worth familiarising yourself with all these columns using <code>head(food_outlets)</code> first. The key variables we will be using are:</p>
<ul>
<li>Geocode.Longitude - longitude for location of premises</li>
<li>Geocode.Latitude - latitude for location of premises</li>
</ul>
<p>We also will load in the boundary shapefile for Liverpool here, to help provide a background for our points.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="cluster.html#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf) <span class="co"># Load package</span></span></code></pre></div>
<pre><code>## Registered S3 methods overwritten by &#39;tibble&#39;:
##   method     from  
##   format.tbl pillar
##   print.tbl  pillar</code></pre>
<pre><code>## Linking to GEOS 3.7.2, GDAL 2.4.2, PROJ 5.2.0</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="cluster.html#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load food outlets data</span></span>
<span id="cb4-2"><a href="cluster.html#cb4-2" aria-hidden="true" tabindex="-1"></a>food_outlets <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;./Data/liverpool_food_outlets.csv&quot;</span>) <span class="co"># Load data</span></span>
<span id="cb4-3"><a href="cluster.html#cb4-3" aria-hidden="true" tabindex="-1"></a>food_outlets <span class="ot">&lt;-</span> food_outlets[<span class="sc">!</span><span class="fu">is.na</span>(food_outlets<span class="sc">$</span>Geocode.Latitude),] <span class="co"># Drop missing co-ordinates (e.g., burger vans that have no fixed position) since cannot plot them</span></span>
<span id="cb4-4"><a href="cluster.html#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="cluster.html#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to spatial points data frame</span></span>
<span id="cb4-6"><a href="cluster.html#cb4-6" aria-hidden="true" tabindex="-1"></a>food_outlets_sp <span class="ot">&lt;-</span> food_outlets <span class="sc">%&gt;%</span> <span class="co"># For object</span></span>
<span id="cb4-7"><a href="cluster.html#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;Geocode.Longitude&quot;</span>, <span class="st">&quot;Geocode.Latitude&quot;</span>)) <span class="sc">%&gt;%</span> <span class="co"># Define as spatial object and identify which columns tell us the position of points</span></span>
<span id="cb4-8"><a href="cluster.html#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_set_crs</span>(<span class="dv">4326</span>) <span class="co"># Set CRS</span></span>
<span id="cb4-9"><a href="cluster.html#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="cluster.html#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Liverpool outline</span></span>
<span id="cb4-11"><a href="cluster.html#cb4-11" aria-hidden="true" tabindex="-1"></a>liverpool <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">&quot;./Shapefiles/Liverpool_LAD/england_lad_2011.shp&quot;</span>)  <span class="co"># Load in shapefile</span></span>
<span id="cb4-12"><a href="cluster.html#cb4-12" aria-hidden="true" tabindex="-1"></a>liverpool <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(liverpool, <span class="dv">4326</span>) <span class="co"># Reproject to same as long/lat format</span></span></code></pre></div>
<p>Ok, with the data loaded in, we can now map the points.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="cluster.html#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2) <span class="co"># Load package</span></span>
<span id="cb5-2"><a href="cluster.html#cb5-2" aria-hidden="true" tabindex="-1"></a>map1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="co"># Call ggplot command</span></span>
<span id="cb5-3"><a href="cluster.html#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> liverpool) <span class="sc">+</span> <span class="co"># Load liverpool outline</span></span>
<span id="cb5-4"><a href="cluster.html#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> food_outlets_sp) <span class="sc">+</span> <span class="co"># Plot food outlet as dots</span></span>
<span id="cb5-5"><a href="cluster.html#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Longitude&quot;</span>) <span class="sc">+</span> <span class="co"># Add x-axis label</span></span>
<span id="cb5-6"><a href="cluster.html#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Latitude&quot;</span>) <span class="sc">+</span> <span class="co"># Add y-axis label</span></span>
<span id="cb5-7"><a href="cluster.html#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Food outlets in Liverpool&quot;</span>) <span class="co"># Edit plot title</span></span>
<span id="cb5-8"><a href="cluster.html#cb5-8" aria-hidden="true" tabindex="-1"></a>map1 <span class="co"># Print plot</span></span></code></pre></div>
<p><img src="Spatial-Data_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<p>Hmmmm, you may see there is an issue with interpretating this plot - many of the plots overlap each other making it difficult to determine underlying patterns. We therefore need a way of summarising this information.</p>
<p>Histograms are useful plots for examining the distribution of single variables - we can apply them spatially by creating <strong>spatial histograms</strong>. To do this, we need to create spatial <strong>bins</strong> and then count how many points are in each of those bins. We use this binning approach when producing histograms for single variables (e.g., counting how many points exist at each value of a variable) and just extend it here for each x,y position on a map. I recommend using a <strong>hex</strong> approach, since hexagons can minimise visual artefacts that can be created through other shapes.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="cluster.html#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(viridis) <span class="co"># Load package</span></span></code></pre></div>
<pre><code>## Loading required package: viridisLite</code></pre>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="cluster.html#cb8-1" aria-hidden="true" tabindex="-1"></a>map2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="co"># Call ggplot2</span></span>
<span id="cb8-2"><a href="cluster.html#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> liverpool) <span class="sc">+</span> <span class="co"># Load liverpool outline</span></span>
<span id="cb8-3"><a href="cluster.html#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hex</span>(<span class="at">data =</span> food_outlets, <span class="fu">aes</span>(<span class="at">x =</span> Geocode.Longitude, <span class="at">y =</span> Geocode.Latitude)) <span class="sc">+</span> <span class="co"># Define data to be plotted</span></span>
<span id="cb8-4"><a href="cluster.html#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>() <span class="sc">+</span> <span class="co"># Make colour blind friendly</span></span>
<span id="cb8-5"><a href="cluster.html#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Longitude&quot;</span>) <span class="sc">+</span> <span class="co"># Add x-axis label</span></span>
<span id="cb8-6"><a href="cluster.html#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Latitude&quot;</span>) <span class="sc">+</span> <span class="co"># Add y-axis label</span></span>
<span id="cb8-7"><a href="cluster.html#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Food outlets in Liverpool&quot;</span>) <span class="co"># Edit plot title</span></span>
<span id="cb8-8"><a href="cluster.html#cb8-8" aria-hidden="true" tabindex="-1"></a>map2</span></code></pre></div>
<p><img src="Spatial-Data_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<p>We can now see the clustering of points in the city centre, with food outlets covering most of the city.</p>
</div>
<div id="kernal-density-estimation" class="section level3" number="2.1.2">
<h3><span class="header-section-number">2.1.2</span> Kernal Density Estimation</h3>
<p>An alternative approach might be to use <strong>Kernal Density Estimation (KDE)</strong> which can create a continuous surface for the density/clustering of points. This avoids the limitation of spatial histograms through creating a single map with no boundaries, rather than splitting up areas into arbitrary bins. KDE or density plots are often used as alternative to standard histograms.</p>
<p>Here we are measuring the intensity or density of points for a given location. We can run these analyses in <code>ggplot2</code> using the <code>stat_density2d_filled</code> command.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="cluster.html#cb9-1" aria-hidden="true" tabindex="-1"></a>map3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="co"># Call ggplot2</span></span>
<span id="cb9-2"><a href="cluster.html#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">data =</span> liverpool) <span class="sc">+</span> <span class="co"># Load liverpool outline</span></span>
<span id="cb9-3"><a href="cluster.html#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_density2d_filled</span>( <span class="co"># Call KDE or smoothed density plot</span></span>
<span id="cb9-4"><a href="cluster.html#cb9-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> food_outlets, <span class="fu">aes</span>(<span class="at">x =</span> Geocode.Longitude, <span class="at">y =</span> Geocode.Latitude, <span class="co"># Define data and locations</span></span>
<span id="cb9-5"><a href="cluster.html#cb9-5" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">fill =</span> ..level..,<span class="at">alpha=</span>..level..), <span class="co"># Set paramters for colouring in values</span></span>
<span id="cb9-6"><a href="cluster.html#cb9-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">n =</span> <span class="dv">100</span> <span class="co"># Modify and see how changes the map (is number of neighbours to derive clustering from)</span></span>
<span id="cb9-7"><a href="cluster.html#cb9-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb9-8"><a href="cluster.html#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_viridis</span>() <span class="sc">+</span> <span class="co"># Make colour blind friendly</span></span>
<span id="cb9-9"><a href="cluster.html#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">&quot;Longitude&quot;</span>) <span class="sc">+</span> <span class="co"># Add x-axis label</span></span>
<span id="cb9-10"><a href="cluster.html#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;Latitude&quot;</span>) <span class="sc">+</span> <span class="co"># Add y-axis label</span></span>
<span id="cb9-11"><a href="cluster.html#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Food outlets in Liverpool&quot;</span>) <span class="co"># Edit plot title</span></span>
<span id="cb9-12"><a href="cluster.html#cb9-12" aria-hidden="true" tabindex="-1"></a>map3</span></code></pre></div>
<p><img src="Spatial-Data_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<p>The resulting map is similar to the hexmap earlier, but we now have one contiguous and single surface for the data. It is worth playing about with the number of neighbours to examine how the algorithm changes the resulting map. Sometimes these are called ‘heatmaps.’</p>
</div>
<div id="spatial-interpolation" class="section level3" number="2.1.3">
<h3><span class="header-section-number">2.1.3</span> Spatial interpolation</h3>
<p>Sometimes the point data that we have contain values or variables that tell us information about them. Here we might be interested in values themselves, rather than the clustering of their locations. We therefore need a different approach here.</p>
<p>To demonstrate how to visualise and extract some value here, we will use a new dataset. The data can be found <a href="https://qof.digital.nhs.uk/">here</a> and are open data. I have done some additional cleaning on the data and extracted their spatial locations to save us time. There is active debate over how useful these data are, but they provide a helpful case study. The variables in the dataset are:</p>
<ul>
<li>pcn_code - unique code for the primary care network (groups of GP practices/surgeries)</li>
<li>pcn_name - name for primary care network</li>
<li>gp_code - unique code for GP surgery</li>
<li>gp_name - name of GP surgery</li>
<li>chronic_heart_disease_percent - estimated percentage of people at the surgery who have chronic heart disease</li>
<li>obese_percent - estimated percentage of people who are defined as obese</li>
<li>postcode - postcode for GP surgery</li>
<li>longitude - longitude location</li>
<li>latitude - latitude location</li>
</ul>
<p>Let’s load in these data.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="cluster.html#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data</span></span>
<span id="cb10-2"><a href="cluster.html#cb10-2" aria-hidden="true" tabindex="-1"></a>gp_locations <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;./Data/gp_qof_1920.csv&quot;</span>)</span>
<span id="cb10-3"><a href="cluster.html#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="cluster.html#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert to spatial points data frame</span></span>
<span id="cb10-5"><a href="cluster.html#cb10-5" aria-hidden="true" tabindex="-1"></a>gp_locations_sp <span class="ot">&lt;-</span> gp_locations <span class="sc">%&gt;%</span> <span class="co"># For object</span></span>
<span id="cb10-6"><a href="cluster.html#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;longitude&quot;</span>, <span class="st">&quot;latitude&quot;</span>)) <span class="sc">%&gt;%</span> <span class="co"># Define as spatial object and identify which columns tell us the position of points</span></span>
<span id="cb10-7"><a href="cluster.html#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_set_crs</span>(<span class="dv">4326</span>) <span class="co"># Set CRS</span></span></code></pre></div>
<p>There are numerous ways that we might plot or visualise these data. First, we could simply assign colours to each point based on their values. We will explore this using the data on percentage of registered patients who are obese.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="cluster.html#cb11-1" aria-hidden="true" tabindex="-1"></a>map4 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="co"># Call ggplot2</span></span>
<span id="cb11-2"><a href="cluster.html#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> liverpool) <span class="sc">+</span> <span class="co"># Plot Liverpool outline</span></span>
<span id="cb11-3"><a href="cluster.html#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> gp_locations_sp, <span class="fu">aes</span>(<span class="at">color =</span> obese_percent), <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span> <span class="co"># Define what to map (adjusted size to make easier to see)</span></span>
<span id="cb11-4"><a href="cluster.html#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis</span>() <span class="sc">+</span> <span class="co"># Make colour blind friendly</span></span>
<span id="cb11-5"><a href="cluster.html#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Longitude&quot;</span>) <span class="sc">+</span> <span class="co"># Add x-axis label</span></span>
<span id="cb11-6"><a href="cluster.html#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Latitude&quot;</span>) <span class="sc">+</span> <span class="co"># Add y-axis label</span></span>
<span id="cb11-7"><a href="cluster.html#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Percentage of patients who are obese&quot;</span>, <span class="co"># Edit plot title </span></span>
<span id="cb11-8"><a href="cluster.html#cb11-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">&quot;Obesity (%)&quot;</span>) <span class="co"># Edit legend title (note must match color as that is what we are plotting)</span></span>
<span id="cb11-9"><a href="cluster.html#cb11-9" aria-hidden="true" tabindex="-1"></a>map4</span></code></pre></div>
<p><img src="Spatial-Data_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>This is a little hard to see general patterns, but follows what we learnt last week.</p>
<p>A second approach would be to adjust the size of the dots in relation to their value.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="cluster.html#cb12-1" aria-hidden="true" tabindex="-1"></a>map5 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="co"># Call ggplot2</span></span>
<span id="cb12-2"><a href="cluster.html#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> liverpool) <span class="sc">+</span> <span class="co"># Plot Liverpool outline</span></span>
<span id="cb12-3"><a href="cluster.html#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> gp_locations_sp, <span class="fu">aes</span>(<span class="at">size =</span> obese_percent),) <span class="sc">+</span> <span class="co"># Define what to map</span></span>
<span id="cb12-4"><a href="cluster.html#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_viridis</span>() <span class="sc">+</span> <span class="co"># Make colour blind friendly</span></span>
<span id="cb12-5"><a href="cluster.html#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Longitude&quot;</span>) <span class="sc">+</span> <span class="co"># Add x-axis label</span></span>
<span id="cb12-6"><a href="cluster.html#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Latitude&quot;</span>) <span class="sc">+</span> <span class="co"># Add y-axis label</span></span>
<span id="cb12-7"><a href="cluster.html#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Percentage of patients who are obese&quot;</span>, <span class="co"># Edit plot title </span></span>
<span id="cb12-8"><a href="cluster.html#cb12-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">size =</span> <span class="st">&quot;Obesity (%)&quot;</span>) <span class="co"># Edit legend title (note must match size as that is what we are plotting)</span></span>
<span id="cb12-9"><a href="cluster.html#cb12-9" aria-hidden="true" tabindex="-1"></a>map5</span></code></pre></div>
<p><img src="Spatial-Data_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<p>Adjusting the size of points can be visually more striking, but is also harder to interpret the exact values. It is easier for the human mind to judge differences in colour rather than differences in sizes of points. Try identifying locations that are grouped as 15 or 20 on the map - it’s hard!</p>
<p>Since our maps only present data for the spatial points themselves, we may want to estimate what the data might be like inbetween points to help identify the area extent of clusters or general spatial patterns. Here, we would turn to <strong>spatial interpolation</strong> techniques that can create a continuous surface based on given point values.</p>
<p>There are various spatial interpolation techniques that we can then use to fill in the gaps including inverse distance weighting or spatial kriging techniques. In this tutorial, we will just use non-linear <strong>splines</strong> to estimate values inbetween points. Splines are faster to run, but may give less precise results.</p>
<p>The following code below runs the interpolation code and then sorts the data out to a format for mapping. We need a couple of new packages here - <code>akima</code> and <code>reshape2</code> - although, we will only use them briefly so I will not describe them in detail.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="cluster.html#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Interpolate data</span></span>
<span id="cb13-2"><a href="cluster.html#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(akima) <span class="co"># Load package</span></span>
<span id="cb13-3"><a href="cluster.html#cb13-3" aria-hidden="true" tabindex="-1"></a>obese_interp <span class="ot">&lt;-</span> <span class="fu">with</span>(gp_locations, <span class="fu">interp</span>(<span class="at">x =</span> longitude, <span class="at">y =</span> latitude, <span class="at">z =</span> obese_percent, <span class="at">duplicate =</span> <span class="st">&quot;mean&quot;</span>, <span class="at">linear =</span> <span class="cn">FALSE</span>)) <span class="co"># Set parameters for spatial location, what to predict, how to deal with duplicate values (i.e., take the mean), and linear = FALSE means uses cubic splines</span></span>
<span id="cb13-4"><a href="cluster.html#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="cluster.html#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Data wrangling</span></span>
<span id="cb13-6"><a href="cluster.html#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reshape2) <span class="co"># Load package</span></span>
<span id="cb13-7"><a href="cluster.html#cb13-7" aria-hidden="true" tabindex="-1"></a>pred_obese_df <span class="ot">&lt;-</span> <span class="fu">melt</span>(obese_interp<span class="sc">$</span>z, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="co"># Convert predicted values from a list (in wide format) to data frame (in long format)</span></span>
<span id="cb13-8"><a href="cluster.html#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(pred_obese_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="st">&quot;obese_percent&quot;</span>) <span class="co"># Rename columns</span></span>
<span id="cb13-9"><a href="cluster.html#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="cluster.html#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort out longitude values</span></span>
<span id="cb13-11"><a href="cluster.html#cb13-11" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">melt</span>(obese_interp<span class="sc">$</span>x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="co"># Convert longitude values from list format to data frame</span></span>
<span id="cb13-12"><a href="cluster.html#cb13-12" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">row.names</span>(x), x, <span class="at">row.names =</span> <span class="cn">NULL</span>) <span class="co"># Save row values as column (these match up to melt values x)</span></span>
<span id="cb13-13"><a href="cluster.html#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(x) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;longitude&quot;</span>) <span class="co"># Rename columns</span></span>
<span id="cb13-14"><a href="cluster.html#cb13-14" aria-hidden="true" tabindex="-1"></a>pred_obese_df <span class="ot">&lt;-</span> <span class="fu">merge</span>(pred_obese_df, x, <span class="at">by =</span> <span class="st">&quot;x&quot;</span>, <span class="at">all.x =</span> T) <span class="co"># Join on longitude values to their lookup values from the melt process</span></span>
<span id="cb13-15"><a href="cluster.html#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(x) <span class="co"># Tidy</span></span>
<span id="cb13-16"><a href="cluster.html#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="cluster.html#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort out latitude values</span></span>
<span id="cb13-18"><a href="cluster.html#cb13-18" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">melt</span>(obese_interp<span class="sc">$</span>y, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="co"># Convert longitude values from list format to data frame</span></span>
<span id="cb13-19"><a href="cluster.html#cb13-19" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">row.names</span>(y), y, <span class="at">row.names =</span> <span class="cn">NULL</span>) <span class="co"># Save row values as column (these match up to melt values y)</span></span>
<span id="cb13-20"><a href="cluster.html#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(y) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;y&quot;</span>, <span class="st">&quot;latitude&quot;</span>) <span class="co"># Rename columns</span></span>
<span id="cb13-21"><a href="cluster.html#cb13-21" aria-hidden="true" tabindex="-1"></a>pred_obese_df <span class="ot">&lt;-</span> <span class="fu">merge</span>(pred_obese_df, y, <span class="at">by =</span> <span class="st">&quot;y&quot;</span>, <span class="at">all.x =</span> T) <span class="co"># Join on longitude values to their lookup values from the melt process</span></span>
<span id="cb13-22"><a href="cluster.html#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(y) <span class="co"># Tidy</span></span></code></pre></div>
<p>Phew, that code was rather messy but it does get the job done (if you know a better way, let me know!). We can now plot it using a heat map.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="cluster.html#cb14-1" aria-hidden="true" tabindex="-1"></a>map6 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="co"># Call ggplot2</span></span>
<span id="cb14-2"><a href="cluster.html#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> liverpool) <span class="sc">+</span> <span class="co"># Plot Liverpool outline</span></span>
<span id="cb14-3"><a href="cluster.html#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="at">data =</span> pred_obese_df, <span class="fu">aes</span>(<span class="at">x =</span> longitude, <span class="at">y =</span> latitude, <span class="at">fill =</span> obese_percent)) <span class="sc">+</span> <span class="co"># Define what to map (interpolated values)</span></span>
<span id="cb14-4"><a href="cluster.html#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>() <span class="sc">+</span> <span class="co"># Make colour blind friendly</span></span>
<span id="cb14-5"><a href="cluster.html#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Longitude&quot;</span>) <span class="sc">+</span> <span class="co"># Add x-axis label</span></span>
<span id="cb14-6"><a href="cluster.html#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Latitude&quot;</span>) <span class="sc">+</span> <span class="co"># Add y-axis label</span></span>
<span id="cb14-7"><a href="cluster.html#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Estimated obesity prevalence&quot;</span>, <span class="co"># Edit plot title </span></span>
<span id="cb14-8"><a href="cluster.html#cb14-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">&quot;Obesity (%)&quot;</span>) <span class="co"># Edit legend title (note must match fill as that is what we are plotting)</span></span>
<span id="cb14-9"><a href="cluster.html#cb14-9" aria-hidden="true" tabindex="-1"></a>map6</span></code></pre></div>
<p><img src="Spatial-Data_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p>We should be careful in producing these maps, since we are estimating data inbetween points and the resulting maps may not be correct. For example, it makes an assumption that people go to their nearest GP surgery to where they live, which is not always true. We can see a cluster of high levels of obesity north of the city centre, which is a densely populated deprived area. However, there is a lot of variability in the data and it is a little messy. Hopefully at least it gives you can idea of how to use these techniques and what they can produce.</p>
<p>Can you produce a similar map for chronic health disease prevalence? (tip: the variable required is <code>gp_locations$chronic_heart_disease_percent</code>).</p>
</div>
</div>
<div id="area-data" class="section level2" number="2.2">
<h2><span class="header-section-number">2.2</span> Area data</h2>
<p>These techniques introduced for point-based data do not work with area data. However, we can utilise more powerful techniques to examine the existence of clustering in our data.</p>
<p>We will utilise a new R package - <code>spdep</code> (Spatial Dependence). The package includes a range of functions that are useful for creating spatial weighting schemes which are useful for identifying the spatial structure of datasets, as well as some spatial analysis methods including the spatial autocorrelation measures we will use here.</p>
<p>To highlight some of these techniques, we will return to the data on vaccination uptake from the previous tutorial. Let’s load in the data and remind ourselves of the spatial patterns it contained.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="cluster.html#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get data ready</span></span>
<span id="cb15-2"><a href="cluster.html#cb15-2" aria-hidden="true" tabindex="-1"></a>msoas <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(<span class="st">&quot;./Shapefiles/Liverpool_MSOAs/england_msoa_2011.shp&quot;</span>)  <span class="co"># Load in shapefile for Liverpool MSOAs</span></span>
<span id="cb15-3"><a href="cluster.html#cb15-3" aria-hidden="true" tabindex="-1"></a>vaccine_uptake <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;./Data/msoa_vaccine_10June21.csv&quot;</span>) <span class="co"># Load in vaccine uptake data</span></span>
<span id="cb15-4"><a href="cluster.html#cb15-4" aria-hidden="true" tabindex="-1"></a>msoas <span class="ot">&lt;-</span> <span class="fu">merge</span>(msoas, vaccine_uptake, <span class="at">by.x =</span> <span class="st">&quot;code&quot;</span>, <span class="at">by.y =</span> <span class="st">&quot;msoa_code&quot;</span>, <span class="at">all.x =</span> <span class="cn">TRUE</span>) <span class="co"># Merge the vaccine uptake objects onto the msoa object, based on the columns defined (x = msoas, y = vaccine_uptake), and do this for all observations only in the x (msoas) object</span></span>
<span id="cb15-5"><a href="cluster.html#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="cluster.html#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Map</span></span>
<span id="cb15-7"><a href="cluster.html#cb15-7" aria-hidden="true" tabindex="-1"></a>map7 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span> <span class="co"># Call ggplot command</span></span>
<span id="cb15-8"><a href="cluster.html#cb15-8" aria-hidden="true" tabindex="-1"></a>            <span class="fu">geom_sf</span>(<span class="at">data =</span> msoas, <span class="fu">aes</span>(<span class="at">fill =</span> total_first_dose), <span class="at">lwd =</span> <span class="dv">0</span>) <span class="sc">+</span> <span class="co"># Using a spatial object, plot MSOAs and fill in based on number of people with first COVID-19 dose, with line width = 0 (i.e., not visible)</span></span>
<span id="cb15-9"><a href="cluster.html#cb15-9" aria-hidden="true" tabindex="-1"></a>            <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">&quot;plasma&quot;</span>) <span class="sc">+</span> <span class="co"># Make colour-blind friendly</span></span>
<span id="cb15-10"><a href="cluster.html#cb15-10" aria-hidden="true" tabindex="-1"></a>            <span class="fu">xlab</span>(<span class="st">&quot;Longitude&quot;</span>) <span class="sc">+</span> <span class="co"># Add x-axis label</span></span>
<span id="cb15-11"><a href="cluster.html#cb15-11" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ylab</span>(<span class="st">&quot;Latitude&quot;</span>) <span class="sc">+</span> <span class="co"># Add y-axis label</span></span>
<span id="cb15-12"><a href="cluster.html#cb15-12" aria-hidden="true" tabindex="-1"></a>            <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;First dose COVID-19 vaccinations&quot;</span>, <span class="co"># Add title to map</span></span>
<span id="cb15-13"><a href="cluster.html#cb15-13" aria-hidden="true" tabindex="-1"></a>                 <span class="at">fill =</span> <span class="st">&quot;Frequency&quot;</span>) <span class="co"># Edit legend title</span></span>
<span id="cb15-14"><a href="cluster.html#cb15-14" aria-hidden="true" tabindex="-1"></a>map7 <span class="co"># Print plot</span></span></code></pre></div>
<p><img src="Spatial-Data_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<div id="global-morans-i" class="section level3" number="2.2.1">
<h3><span class="header-section-number">2.2.1</span> Global Moran’s I</h3>
<p>The first step we would want to take is to describe the overall extent of spatial clustering of any variable. To do this, we will calculate a global Moran’s I statistic that can tell us the extent of clustering of data. You can review the methodology behind this in the related lecture slides <a href="">here</a>.</p>
<p>To be able to describe the clustering, we need to tell R about the spatial structure of our dataset. Specifically, we need to identify which areas are located next to each other (i.e., neighbours).</p>
<p>As we are dealing with area (polygons) spatial data, we will define spatial neighbours based on which borders they match on. So if two areas share a common border, then we can define them as neighbouring each other. There are two ways of defining this process:</p>
<ul>
<li>Rook contiguity - only areas that share common borders/edges of some defined length</li>
<li>Queen contiguity - all areas that touch each other are considered neighbours, even if the shared space is very small</li>
</ul>
<p>To calculate the spatial structuring of neighbouring areas, we run the following code.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="cluster.html#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(spdep) <span class="co"># Load package</span></span></code></pre></div>
<pre><code>## Loading required package: sp</code></pre>
<pre><code>## Loading required package: spData</code></pre>
<pre><code>## To access larger datasets in this package, install the spDataLarge
## package with: `install.packages(&#39;spDataLarge&#39;,
## repos=&#39;https://nowosad.github.io/drat/&#39;, type=&#39;source&#39;)`</code></pre>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="cluster.html#cb20-1" aria-hidden="true" tabindex="-1"></a>nb <span class="ot">&lt;-</span> <span class="fu">poly2nb</span>(msoas, <span class="at">queen =</span> <span class="cn">TRUE</span>) <span class="co"># Calculate queen contiguity for areas (set queen = FALSE for rook contiguity)</span></span></code></pre></div>
<p>We now need to assign spatial weights to each area (polygon) based on the spatial structure of the data. These weights are important when we are calculating the average values of neighbours, but adjusting their values.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="cluster.html#cb21-1" aria-hidden="true" tabindex="-1"></a>lw <span class="ot">&lt;-</span> <span class="fu">nb2listw</span>(nb, <span class="at">style =</span> <span class="st">&quot;W&quot;</span>, <span class="at">zero.policy =</span> <span class="cn">TRUE</span>) <span class="co"># Assign weights based on list of neighbours. Each neighbouring area is given an equal weighting (syle = &quot;W&quot;). Zero.policy = TRUE allows for areas with no neighbours.</span></span></code></pre></div>
<p>Now that we have weightings for each areas linked to its neighbours, we can calculate the global Moran’s I. Essentially, it is looking at the correlation between each area’s value and the average values for surrounding neighbours. This gives a crude descriptive value of the amount of clustering in our data - it is termed ‘global’ since it is an average for all areas.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="cluster.html#cb22-1" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">&lt;-</span> <span class="fu">moran.test</span>(msoas<span class="sc">$</span>total_first_dose, lw) <span class="co"># Calculate Moran&#39;s I</span></span>
<span id="cb22-2"><a href="cluster.html#cb22-2" aria-hidden="true" tabindex="-1"></a>m1 <span class="co"># Print result</span></span></code></pre></div>
<pre><code>## 
##  Moran I test under randomisation
## 
## data:  msoas$total_first_dose  
## weights: lw    
## 
## Moran I statistic standard deviate = 1.5264, p-value = 0.06345
## alternative hypothesis: greater
## sample estimates:
## Moran I statistic       Expectation          Variance 
##       0.107062246      -0.016666667       0.006570535</code></pre>
<p>There is a lot of output here, however we are really only interested in two things mostly. The Moran’s I statistic is 0.1070622. We interpret the estimated value was running between -1 and 1, where values closer to 1 suggest existence of spatial clustering, values of 0 suggesting no clustering (i.e., random), and values less than 0 suggesting evenly dispersed values (rare in the real world). Some rules of thumbs - a value of 0.3 would suggest low-moderate clustering, with values 0.5+ suggestung moderate to high clustering. A value of 0.1070622 suggests little evidence of clustering in the data.</p>
<p>We can also consider the p-value to assess if the result is statistically significant <del>notwithstanding the continued controversy on using p-values</del>. A value of 0.0634541 suggests that the result is not statistically significant, lending further evidence towards a conclusion that there is little evidence of spatial clustering.</p>
<p>To get a more accurate p-value, we should use Monte Carlo simulations to estimate it. Let’s try this, but this time looking at the clustering of second dose COVID-19 vaccinations.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="cluster.html#cb24-1" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> <span class="fu">moran.mc</span>(msoas<span class="sc">$</span>total_second_dose, lw, <span class="at">nsim =</span> <span class="dv">1000</span>) <span class="co"># Calculate Moran&#39;s I and simulate 1000 times permutations to give more accurate p-value</span></span>
<span id="cb24-2"><a href="cluster.html#cb24-2" aria-hidden="true" tabindex="-1"></a>m2 <span class="co"># Print result</span></span></code></pre></div>
<pre><code>## 
##  Monte-Carlo simulation of Moran I
## 
## data:  msoas$total_second_dose 
## weights: lw  
## number of simulations + 1: 1001 
## 
## statistic = 0.30176, observed rank = 1001, p-value = 0.000999
## alternative hypothesis: greater</code></pre>
<p>Here we find some evidence of clustering in the data, with a value of suggesting low to moderate clustering in the data.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="cluster.html#cb26-1" aria-hidden="true" tabindex="-1"></a>m2_plot <span class="ot">&lt;-</span> <span class="fu">moran.plot</span>(msoas<span class="sc">$</span>total_second_dose, <span class="at">listw =</span> lw, <span class="at">plot =</span> <span class="cn">FALSE</span>)  <span class="co"># Save raw moran&#39;s I data (if run without saving as an object, it will plot in base R if you set plot = TRUE (default)- for our purposes, I have shown how to get it into ggplot2 as it looks nicer</span></span>
<span id="cb26-2"><a href="cluster.html#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="cluster.html#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb26-4"><a href="cluster.html#cb26-4" aria-hidden="true" tabindex="-1"></a>plot1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> m2_plot, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> wx)) <span class="sc">+</span> <span class="co"># Plot x (actual values) and wx (average for neighbours)</span></span>
<span id="cb26-5"><a href="cluster.html#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="co"># Scatter plot</span></span>
<span id="cb26-6"><a href="cluster.html#cb26-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>) <span class="sc">+</span> <span class="co"># Line of best fit</span></span>
<span id="cb26-7"><a href="cluster.html#cb26-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">&quot;Number of second doses&quot;</span>) <span class="sc">+</span> <span class="co"># Label x-axis</span></span>
<span id="cb26-8"><a href="cluster.html#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(<span class="st">&quot;Spatially lagged number of second doses&quot;</span>)</span>
<span id="cb26-9"><a href="cluster.html#cb26-9" aria-hidden="true" tabindex="-1"></a>plot1 <span class="co"># Print plot</span></span></code></pre></div>
<pre><code>## `geom_smooth()` using formula &#39;y ~ x&#39;</code></pre>
<p><img src="Spatial-Data_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
</div>
<div id="local-morans-i" class="section level3" number="2.2.2">
<h3><span class="header-section-number">2.2.2</span> Local Moran’s I</h3>
<p>If we find evidence of clustering overall, then the next step is to describe where this clustering exists. The global Moran’s I for number of second COVID-19 vaccine doses suggested some clustering of values, let’s explore where the clustering exists and the nature of it. Using a local Moran’s I, we can calculate the extent each area belongs to a cluster of high or low values.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="cluster.html#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate metrics</span></span>
<span id="cb28-2"><a href="cluster.html#cb28-2" aria-hidden="true" tabindex="-1"></a>local_2nd <span class="ot">&lt;-</span> <span class="fu">localmoran</span>(<span class="at">x =</span> msoas<span class="sc">$</span>total_second_dose, <span class="at">listw =</span> lw) <span class="co"># Calculate local Moran&#39;s I</span></span>
<span id="cb28-3"><a href="cluster.html#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co"># local_2nd &lt;- localmoran_perm((x = msoas$total_second_dose, listw = lw, nsim=499) # In case want to run more simulations to get a more accurate level of significance</span></span>
<span id="cb28-4"><a href="cluster.html#cb28-4" aria-hidden="true" tabindex="-1"></a>local_2nd_map <span class="ot">&lt;-</span> <span class="fu">cbind</span>(msoas, local_2nd) <span class="co"># Join estimates onto shapefile for MSOAs</span></span>
<span id="cb28-5"><a href="cluster.html#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="cluster.html#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Map</span></span>
<span id="cb28-7"><a href="cluster.html#cb28-7" aria-hidden="true" tabindex="-1"></a>map8 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb28-8"><a href="cluster.html#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> local_2nd_map, <span class="fu">aes</span>(<span class="at">fill =</span> Ii)) <span class="sc">+</span> <span class="co"># Plot local Moran&#39;s I statistic (z score)</span></span>
<span id="cb28-9"><a href="cluster.html#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>() <span class="sc">+</span> <span class="co"># Make colour blind friendly</span></span>
<span id="cb28-10"><a href="cluster.html#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Longitude&quot;</span>) <span class="sc">+</span> <span class="co"># Add x-axis label</span></span>
<span id="cb28-11"><a href="cluster.html#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Latitude&quot;</span>) <span class="sc">+</span> <span class="co"># Add y-axis label</span></span>
<span id="cb28-12"><a href="cluster.html#cb28-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Clustering of second dose uptake&quot;</span>, <span class="co"># Edit plot title </span></span>
<span id="cb28-13"><a href="cluster.html#cb28-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">&quot;Local Moran&#39;s I&quot;</span>) <span class="co"># Edit legend title (note must match fill as that is what we are plotting)</span></span>
<span id="cb28-14"><a href="cluster.html#cb28-14" aria-hidden="true" tabindex="-1"></a>map8 <span class="co"># Plot</span></span></code></pre></div>
<p><img src="Spatial-Data_files/figure-html/unnamed-chunk-16-1.png" width="672" /></p>
<p>The map tells us how different each area is to it’s surrounding areas , with areas with higher z-scores representing areas that are clustered by higher values in the surrounding areas, and lower scores the opposite (surrounded by lower values). The map suggests a cluster in the city centre area, as well as a less distinct one to the South East. To understand how meaningful these spatial patterns are, we can plot the p-values for areas.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="cluster.html#cb29-1" aria-hidden="true" tabindex="-1"></a>map9 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb29-2"><a href="cluster.html#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> local_2nd_map, <span class="fu">aes</span>(<span class="at">fill =</span> Pr.z...<span class="fl">0.</span>)) <span class="sc">+</span> <span class="co"># Plot local Moran&#39;s I statistic (z score)</span></span>
<span id="cb29-3"><a href="cluster.html#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>() <span class="sc">+</span> <span class="co"># Make colour blind friendly</span></span>
<span id="cb29-4"><a href="cluster.html#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Longitude&quot;</span>) <span class="sc">+</span> <span class="co"># Add x-axis label</span></span>
<span id="cb29-5"><a href="cluster.html#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Latitude&quot;</span>) <span class="sc">+</span> <span class="co"># Add y-axis label</span></span>
<span id="cb29-6"><a href="cluster.html#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Clustering of second dose uptake&quot;</span>, <span class="co"># Edit plot title </span></span>
<span id="cb29-7"><a href="cluster.html#cb29-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">&quot;p-value&quot;</span>) <span class="co"># Edit legend title (note must match fill as that is what we are plotting)</span></span>
<span id="cb29-8"><a href="cluster.html#cb29-8" aria-hidden="true" tabindex="-1"></a>map9 <span class="co"># Plot</span></span></code></pre></div>
<p><img src="Spatial-Data_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
<p>What the map is missing is the nature of the clusters. We can say with some confidence that there is a cluster in the city centre for example, but we are not sure what this is a cluster of. We could compare manually to <code>map7</code>, however it would be useful to have a single map the brings together all of this information. To help contextualise the clustering analysis, we need to classify the local Moran’s I data to describe their patterns.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="cluster.html#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data wrangling</span></span>
<span id="cb30-2"><a href="cluster.html#cb30-2" aria-hidden="true" tabindex="-1"></a>quadrant <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">mode=</span><span class="st">&quot;numeric&quot;</span>, <span class="at">length =</span> <span class="fu">nrow</span>(local_2nd)) <span class="co"># Create blank object for storing results</span></span>
<span id="cb30-3"><a href="cluster.html#cb30-3" aria-hidden="true" tabindex="-1"></a>m_2nd <span class="ot">&lt;-</span> msoas<span class="sc">$</span>total_second_dose <span class="sc">-</span> <span class="fu">mean</span>(msoas<span class="sc">$</span>total_second_dose) <span class="co"># Centers each area around its mean (for variable under investigation)</span></span>
<span id="cb30-4"><a href="cluster.html#cb30-4" aria-hidden="true" tabindex="-1"></a>m_localmi <span class="ot">&lt;-</span> local_2nd[,<span class="dv">1</span>] <span class="sc">-</span> <span class="fu">mean</span>(local_2nd[,<span class="dv">1</span>]) <span class="co"># Centers areas on the local Moran&#39;s I values around the mean</span></span>
<span id="cb30-5"><a href="cluster.html#cb30-5" aria-hidden="true" tabindex="-1"></a>sig <span class="ot">&lt;-</span> <span class="fl">0.1</span> <span class="co"># Define statistical significance threshold (feel free to select more stringent values)</span></span>
<span id="cb30-6"><a href="cluster.html#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="cluster.html#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Populate the blank object with our classification of results</span></span>
<span id="cb30-8"><a href="cluster.html#cb30-8" aria-hidden="true" tabindex="-1"></a>quadrant[m_2nd <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> m_localmi <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># Low-low: Lower than average raw value, lower than average surrounding areas</span></span>
<span id="cb30-9"><a href="cluster.html#cb30-9" aria-hidden="true" tabindex="-1"></a>quadrant[m_2nd <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> m_localmi <span class="sc">&gt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="co"># Low-high: Lower than average raw value, higher than average surrounding areas</span></span>
<span id="cb30-10"><a href="cluster.html#cb30-10" aria-hidden="true" tabindex="-1"></a>quadrant[m_2nd <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> m_localmi <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">3</span> <span class="co"># High-low: Higher than average raw value, lower than average surrounding areas</span></span>
<span id="cb30-11"><a href="cluster.html#cb30-11" aria-hidden="true" tabindex="-1"></a>quadrant[m_2nd <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> m_localmi <span class="sc">&gt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">4</span> <span class="co"># High-high: Higher than average raw value, higher than average surrounding areas</span></span>
<span id="cb30-12"><a href="cluster.html#cb30-12" aria-hidden="true" tabindex="-1"></a>quadrant[local_2nd[,<span class="dv">5</span>] <span class="sc">&gt;</span> sig] <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co"># Identify non-significant areas</span></span>
<span id="cb30-13"><a href="cluster.html#cb30-13" aria-hidden="true" tabindex="-1"></a>quadrant <span class="ot">&lt;-</span> <span class="fu">factor</span>(quadrant, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">&quot;0&quot;</span>, <span class="st">&quot;1&quot;</span>, <span class="st">&quot;2&quot;</span>, <span class="st">&quot;3&quot;</span>, <span class="st">&quot;4&quot;</span>)) <span class="co"># Define variable as factor (as distinct categories)</span></span>
<span id="cb30-14"><a href="cluster.html#cb30-14" aria-hidden="true" tabindex="-1"></a>local_2nd_map2 <span class="ot">&lt;-</span> <span class="fu">cbind</span>(msoas, quadrant) <span class="co"># Join data onto the original shapefile</span></span>
<span id="cb30-15"><a href="cluster.html#cb30-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-16"><a href="cluster.html#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb30-17"><a href="cluster.html#cb30-17" aria-hidden="true" tabindex="-1"></a>map10 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb30-18"><a href="cluster.html#cb30-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> local_2nd_map2, <span class="fu">aes</span>(<span class="at">fill =</span> quadrant)) <span class="sc">+</span> <span class="co"># Plot values</span></span>
<span id="cb30-19"><a href="cluster.html#cb30-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;0&quot;</span> <span class="ot">=</span> <span class="st">&quot;white&quot;</span>, <span class="st">&quot;1&quot;</span> <span class="ot">=</span> <span class="st">&quot;blue&quot;</span>, <span class="st">&quot;2&quot;</span> <span class="ot">=</span> <span class="fu">rgb</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="at">alpha=</span><span class="fl">0.4</span>), <span class="st">&quot;3&quot;</span> <span class="ot">=</span> <span class="fu">rgb</span>(<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="at">alpha=</span><span class="fl">0.4</span>), <span class="st">&quot;4&quot;</span> <span class="ot">=</span> <span class="st">&quot;red&quot;</span>),</span>
<span id="cb30-20"><a href="cluster.html#cb30-20" aria-hidden="true" tabindex="-1"></a>                    <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;Insignificant&quot;</span>, <span class="st">&quot;Low-low&quot;</span>, <span class="st">&quot;Low-high&quot;</span>, <span class="st">&quot;High-low&quot;</span>, <span class="st">&quot;High-high&quot;</span>),</span>
<span id="cb30-21"><a href="cluster.html#cb30-21" aria-hidden="true" tabindex="-1"></a>                    <span class="at">breaks =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>), </span>
<span id="cb30-22"><a href="cluster.html#cb30-22" aria-hidden="true" tabindex="-1"></a>                    <span class="at">drop =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> <span class="co"># Show all values in legend</span></span>
<span id="cb30-23"><a href="cluster.html#cb30-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Clustering of second dose uptake&quot;</span>, <span class="co"># Edit plot title </span></span>
<span id="cb30-24"><a href="cluster.html#cb30-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">&quot;Clusters&quot;</span>) <span class="sc">+</span> <span class="co"># Edit legend title (note must match fill as that is what we are plotting)</span></span>
<span id="cb30-25"><a href="cluster.html#cb30-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Longitude&quot;</span>) <span class="sc">+</span> <span class="co"># Add labels</span></span>
<span id="cb30-26"><a href="cluster.html#cb30-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Latitude&quot;</span>)</span>
<span id="cb30-27"><a href="cluster.html#cb30-27" aria-hidden="true" tabindex="-1"></a>map10 <span class="co"># Print</span></span></code></pre></div>
<p><img src="Spatial-Data_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<p>This map is a common output in local Moran’s I analyses. It combines the raw data, clustering analysis and associated statistical significance into a single plot. We can see that in the city centre, we have a cluster of low vaccination uptake surrounded by areas with higher values. We then have two significant clusters to the East, representing clusters of higher uptake.</p>
</div>
<div id="getis-ord-gi-statistic" class="section level3" number="2.2.3">
<h3><span class="header-section-number">2.2.3</span> Getis-Ord Gi statistic</h3>
<p>An alternative clustering metric is the Getis-Ord Gi statistic. The Gi statistic is presented as a z-score, with positive values representing clusters of high values and negative values representing clusters of low values.</p>
<p>We can calculate the Gi statistic using the following code.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="cluster.html#cb31-1" aria-hidden="true" tabindex="-1"></a>localGi <span class="ot">&lt;-</span> <span class="fu">localG</span>(msoas<span class="sc">$</span>total_second_dose, <span class="at">listw =</span> lw) <span class="co"># Calculate Gi statistics for each MSOA (second dose total)</span></span></code></pre></div>
<p>As before, the power of the clustering metrics is seen when we map it. Let’s visualise the spatial pattern of clustering.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="cluster.html#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Wrangle data</span></span>
<span id="cb32-2"><a href="cluster.html#cb32-2" aria-hidden="true" tabindex="-1"></a>Gi_map <span class="ot">&lt;-</span> <span class="fu">cbind</span>(msoas, <span class="fu">data.matrix</span>(localGi)) <span class="co"># Join results onto shapefile</span></span>
<span id="cb32-3"><a href="cluster.html#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(Gi_map)[<span class="fu">names</span>(Gi_map) <span class="sc">==</span> <span class="st">&quot;data.matrix.localGi.&quot;</span>] <span class="ot">&lt;-</span> <span class="st">&quot;gstat&quot;</span> <span class="co"># Rename column</span></span>
<span id="cb32-4"><a href="cluster.html#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="cluster.html#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Map</span></span>
<span id="cb32-6"><a href="cluster.html#cb32-6" aria-hidden="true" tabindex="-1"></a>map11 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb32-7"><a href="cluster.html#cb32-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> Gi_map, <span class="fu">aes</span>(<span class="at">fill =</span> gstat)) <span class="sc">+</span></span>
<span id="cb32-8"><a href="cluster.html#cb32-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis</span>() <span class="sc">+</span> <span class="co"># Make colour blind friendly</span></span>
<span id="cb32-9"><a href="cluster.html#cb32-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&quot;Longitude&quot;</span>) <span class="sc">+</span> <span class="co"># Add x-axis label</span></span>
<span id="cb32-10"><a href="cluster.html#cb32-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&quot;Latitude&quot;</span>) <span class="sc">+</span> <span class="co"># Add y-axis label</span></span>
<span id="cb32-11"><a href="cluster.html#cb32-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">&quot;Second dose uptake&quot;</span>, <span class="co"># Edit plot title </span></span>
<span id="cb32-12"><a href="cluster.html#cb32-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">&quot;Gi statistic&quot;</span>) <span class="co"># Edit legend title (note must match fill as that is what we are plotting)</span></span>
<span id="cb32-13"><a href="cluster.html#cb32-13" aria-hidden="true" tabindex="-1"></a>map11</span></code></pre></div>
<p><img src="Spatial-Data_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>
<p>The map produced is both similar and different to the local Moran’s I. We see clustering in the city centre (younger populations) and north parts of Liverpool (more deprived communities), with higher vaccinate uptake in the more affluent South and South-East parts of the city.</p>
</div>
</div>
<div id="summary-1" class="section level2" number="2.3">
<h2><span class="header-section-number">2.3</span> Summary</h2>
<p>So far, you have learned how to use spatial data in R, visualise and map their patterns, and start to analyse the spatial patterns themselves. Next we will move onto spatial extensions of regression techniques.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="intro.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="spatreg.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["Spatial Data.pdf", "Spatial Data.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
